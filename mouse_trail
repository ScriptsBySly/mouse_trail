import pygame
import time
import ctypes

# --- Config ---
CHROMA_GREEN = (0, 255, 0)
TRAIL_RED = (255, 0, 0)
TRAIL_DURATION = 1
TRAIL_THICKNESS = 9
FPS = 60
WINDOW_SCALE = 0.8

pygame.init()

# --- Windows API for global mouse position ---
class POINT(ctypes.Structure):
    _fields_ = [("x", ctypes.c_long), ("y", ctypes.c_long)]

def get_global_mouse_pos():
    pt = POINT()
    ctypes.windll.user32.GetCursorPos(ctypes.byref(pt))
    return pt.x, pt.y

# --- Monitor resolution ---
info = pygame.display.Info()
monitor_w = info.current_w
monitor_h = info.current_h

# --- Window ---
window_w = int(monitor_w * WINDOW_SCALE)
window_h = int(monitor_h * WINDOW_SCALE)

screen = pygame.display.set_mode((window_w, window_h))
pygame.display.set_caption("Global Mouse Trail (Chroma Key)")

clock = pygame.time.Clock()

# Store trail points
mouse_trail = []

running = True
while running:
    now = time.time()

    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False

    # --- Global mouse position (works anywhere) ---
    abs_x, abs_y = get_global_mouse_pos()

    # Normalize to monitor
    norm_x = abs_x / monitor_w
    norm_y = abs_y / monitor_h

    # Clamp (safety)
    norm_x = max(0.0, min(1.0, norm_x))
    norm_y = max(0.0, min(1.0, norm_y))

    # Convert to window space
    win_x = int(norm_x * window_w)
    win_y = int(norm_y * window_h)

    mouse_trail.append(((win_x, win_y), now))

    # Remove old points
    mouse_trail = [
        (pos, t) for pos, t in mouse_trail if now - t <= TRAIL_DURATION
    ]

    # Draw
    screen.fill(CHROMA_GREEN)

    if len(mouse_trail) > 1:
        for i in range(len(mouse_trail) - 1):
            pygame.draw.line(
                screen,
                TRAIL_RED,
                mouse_trail[i][0],
                mouse_trail[i + 1][0],
                TRAIL_THICKNESS
            )

    pygame.display.flip()
    clock.tick(FPS)

pygame.quit()
